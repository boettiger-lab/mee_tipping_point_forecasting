---
title: "scoring"
output: html_document
date: '2022-04-13'
---

```{r}
data <- read_csv("forecasts/block_rnn_stochastic_10.csv.gz")[-1]
emp_draws <- data %>% filter(true_model==TRUE) %>% select(-true_model)
forecasts <- data %>% filter(true_model==FALSE) %>% select(-true_model)
```

```{r}
library(scoringRules)

scores <- function(observed, dat) {
  logsscore <- scoringRules::logs_sample(observed, dat)
  crpsscore <- scoringRules::crps_sample(observed, dat)
  data.frame(logs = mean(logsscore[-1]), crps =  mean(crpsscore[-1]))
}

# Score just the 1st replicate "true" observations
observed <- emp_draws %>%  filter(iter == 0, ensemble==0) %>%  pull(value)
dat <- forecasts %>%  filter(iter == 0, ensemble==0) %>%  select(ensemble, value) %>% as.matrix()
scores(observed, dat)

```
```{r}
# score over all replicates:
all_scores = list()
for (i in (0:4)) {
  for (e in 0:99){
    dat <- forecasts %>%  filter(iter == i, ensemble == e) %>%  select(ensemble, value) %>% as.matrix()
    rep_scores <- emp_draws %>% filter(iter==i) %>%  group_by(ensemble) %>%  group_map(~ scores(.x$value, dat)) %>%  bind_rows()
    all_scores <- append(all_scores, rep_scores)
  }
  print(i)
}

all_scores %>%  summarise(across(.fns= base::mean))

library(patchwork)
ggplot(all_scores) + geom_histogram(aes(crps)) + 
(ggplot(all_scores) + geom_histogram(aes(logs)) )

```