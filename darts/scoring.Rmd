---
title: "scoring"
output: github_document
date: '2022-04-13'
---


```{r}
library(scoringRules)
library(tidyverse)
```


```{r}
data <- read_csv("forecasts/block_rnn_stochastic_10.csv.gz")[-1]
```

```{r}
library(scoringRules)

scores <- function(observed, dat) {
  logsscore <- scoringRules::logs_sample(observed, dat)
  crpsscore <- scoringRules::crps_sample(observed, dat)
  data.frame(logs = mean(logsscore[-1]), crps =  mean(crpsscore[-1]))
}
```


```{r}

score_all <- function(data, groups = NULL) {
  
true <- data |> filter(true_model)
fcst <- data |> filter(!true_model)

dat <- fcst |>
  select(t = time, i = ensemble, N = value) |> 
 pivot_wider(id_cols = "t", names_from="i", values_from = "N") |> 
  select(-t) |> as.matrix()

test <- true  |>
  select(t = time, i = ensemble, N = value)


rep_scores <- 
  test |> 
  group_by(i) |> 
  group_map(~ scores(.x$N, dat)) |> 
  bind_rows()

bind_cols(rep_scores, groups)
}

rep_scores <- data |> 
  group_by(iter, ml_model, tp_model) |>
  group_map(~ score_all(.x, .y) ,.keep = TRUE) |> 
  bind_rows()
```


```{r}
# crude demo
ggplot(rep_scores) + geom_density(aes(crps, color=iter, group=iter)) + facet_grid(ml_model~tp_model)

```